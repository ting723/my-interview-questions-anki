# 分布式

## 分布式一致性

<!-- notecardId: 1735054231468 -->

分布式一致性是指在分布式系统中，多个节点在数据存储和处理上保持一致的能力。由于分布式系统中各个节点可能会出现网络延迟、节点故障等问题，保证数据的一致性是一个重要且复杂的课题。

### CAP 定理

CAP 定理指出，在一个分布式系统中，不可能同时满足以下三个特性：

- **一致性 (Consistency)** ：所有节点在同一时间具有相同的数据。
- **可用性 (Availability)** ：每个请求都能收到一个（成功或失败）响应。
- **分区容忍性 (Partition Tolerance)** ：系统能够继续运行，即使网络分区将一些节点隔离开。

根据 CAP 定理，分布式系统只能在一致性、可用性和分区容忍性之间做出权衡。

### BASE 理论

BASE 理论是对 CAP 定理的进一步扩展，适用于大规模分布式系统。BASE 代表：

- **基本可用 (Basically Available)** ：系统在出现故障时，允许部分可用性下降。
- **软状态 (Soft State)** ：系统状态可以有一段时间的不一致。
- **最终一致性 (Eventual Consistency)** ：系统最终会达到一致状态。

### 两阶段提交协议 (2PC)

两阶段提交协议是一种保证分布式事务一致性的协议，分为两个阶段：

1. **准备阶段**：协调者向所有参与者发送准备请求，参与者执行事务并将结果告知协调者。
2. **提交阶段**：如果所有参与者都准备成功，协调者发送提交请求；否则，发送回滚请求。

### 三阶段提交协议 (3PC)

三阶段提交协议是对两阶段提交协议的改进，增加了一个预备提交阶段，以减少协调者单点故障的影响：

1. **准备阶段**：协调者向所有参与者发送准备请求。
2. **预备提交阶段**：如果所有参与者都准备成功，协调者发送预备提交请求。
3. **提交阶段**：如果所有参与者都预备提交成功，协调者发送提交请求；否则，发送回滚请求。

### Paxos 协议

Paxos 协议是一种分布式一致性算法，主要用于解决分布式系统中的一致性问题。Paxos 协议通过提议者、接受者和学习者三个角色来达成一致。
Paxos 协议是一种经典的分布式一致性算法，由计算机科学家 Leslie Lamport 提出。它主要用于在分布式系统中达成一致性，确保多个节点在面对网络分区、节点故障等问题时，仍能对某个值达成一致。

#### Paxos 协议的角色

Paxos 协议中有三种主要角色：

- **提议者 (Proposer)**：提出提案的节点，负责发起提案并尝试说服多数接受者接受该提案。
- **接受者 (Acceptor)**：接收并投票表决提案的节点，负责存储提案并决定是否接受提案。
- **学习者 (Learner)**：学习最终达成一致的提案的节点，负责了解最终被接受的提案。

#### Paxos 协议的阶段

Paxos 协议通常分为两个主要阶段：

1. **准备阶段 (Prepare Phase)**：
    - 提议者选择一个提案编号 `n`，并向多数接受者发送准备请求（Prepare Request）。
    - 接受者收到准备请求后，如果 `n` 大于其已响应的最大提案编号，则承诺不再接受编号小于 `n` 的提案，并回复提议者其已接受的最大编号的提案（如果有）。

2. **接受阶段 (Accept Phase)**：
    - 提议者在收到多数接受者的准备响应后，选择一个提案值 `v`（通常是接受者返回的最大编号提案的值，或一个新的值），并向多数接受者发送接受请求（Accept Request）。
    - 接受者收到接受请求后，如果 `n` 仍然是其已响应的最大提案编号，则接受该提案并将其存储。

#### Paxos 协议的特点

- **安全性 (Safety)**：Paxos 协议保证在任何情况下，只有一个提案会被接受。
- **活性 (Liveness)**：在没有网络分区且节点正常工作的情况下，Paxos 协议能够最终达成一致。

#### Paxos 协议的变种

由于标准的 Paxos 协议实现复杂且效率较低，许多变种和优化版本被提出，如 Multi-Paxos、Fast Paxos 等。这些变种在不同场景下提供了更高的性能和更好的可用性。

Paxos 协议作为分布式一致性算法的基石，为后续的一致性算法（如 Raft 协议）提供了重要的理论基础。

### Raft 协议

Raft 协议是另一种分布式一致性算法，设计上更易于理解和实现。Raft 协议通过选举领导者来管理日志复制，从而保证一致性。

#### Raft 协议的角色

Raft 协议中有三种主要角色：

- **领导者 (Leader)**：负责处理所有客户端请求，并将日志条目复制到跟随者。
- **跟随者 (Follower)**：被动地接收领导者的日志复制请求，并将其应用到状态机。
- **候选人 (Candidate)**：在选举过程中尝试成为领导者的节点。

#### Raft 协议的阶段

Raft 协议分为三个主要阶段：

1. **领导者选举 (Leader Election)**：
    - 当跟随者在选举超时时间内没有收到领导者的心跳消息时，会转换为候选人并发起选举。
    - 候选人增加其任期号并向其他节点发送请求投票消息。
    - 其他节点收到请求投票消息后，如果尚未投票且候选人的任期号不小于自己的任期号，则投票给候选人。
    - 如果候选人获得多数节点的投票，则成为领导者。

2. **日志复制 (Log Replication)**：
    - 领导者接收客户端请求，将请求作为新的日志条目追加到本地日志中。
    - 领导者将新的日志条目复制到所有跟随者，并等待多数跟随者确认。
    - 当日志条目在多数节点上被复制后，领导者将其应用到状态机并向客户端返回结果。

3. **安全性 (Safety)**：
    - Raft 协议通过任期号和日志索引来保证日志的一致性。
    - 领导者在任期内只能追加日志条目，不能删除或修改已有条目。
    - 跟随者在接收到领导者的日志复制请求时，会根据任期号和日志索引来决定是否接受新的日志条目。

#### Raft 协议的特点

- **易于理解**：Raft 协议设计上更易于理解和实现，相比于 Paxos 更加直观。
- **强一致性**：通过领导者选举和日志复制机制，Raft 协议保证了分布式系统中的强一致性。
- **容错性**：Raft 协议能够容忍少数节点故障，只要多数节点正常工作，系统就能继续运行。

#### Raft 协议的应用

Raft 协议被广泛应用于分布式系统中，如分布式数据库、分布式文件系统和分布式缓存等。其易于理解和实现的特点，使其成为构建分布式一致性系统的首选算法之一。


### 应用场景

分布式一致性在以下场景中尤为重要：

- **分布式数据库**：如 Google Spanner、Amazon DynamoDB 等。
- **分布式文件系统**：如 HDFS、Ceph 等。
- **分布式缓存**：如 Redis 集群、Memcached 等。
- **微服务架构**：保证不同服务之间的数据一致性。

分布式一致性是分布式系统中的核心问题之一，理解和应用相关理论和协议对于构建可靠的分布式系统至关重要。
