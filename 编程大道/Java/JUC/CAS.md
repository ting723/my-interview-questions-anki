# Java

## CAS

<!-- notecardId: 1735049128062 -->

### 定义

CAS（Compare-And-Swap）是一种原子操作，用于实现无锁并发编程。它通过比较内存中的值和预期值，如果相同则更新为新值，否则不做任何操作。

### 特点

- **原子性**：CAS 操作是原子的，不会被中断。
- **无锁**：CAS 不需要锁机制，因此避免了锁带来的开销和死锁问题。
- **自旋**：CAS 操作通常会自旋重试，直到成功为止。

### 面试常见问题

1. **什么是 CAS？**

   - CAS（Compare-And-Swap）是一种原子操作，用于实现无锁并发编程。它通过比较内存中的值和预期值，如果相同则更新为新值，否则不做任何操作。

2. **CAS 的优缺点是什么？**

   - 优点：
     - **高效**：避免了锁机制带来的开销。
     - **无锁**：减少了死锁的风险。
   - 缺点：
     - **ABA 问题**：如果值在比较期间发生了变化，但最终值与预期值相同，CAS 可能无法检测到。
     - **自旋开销**：在高竞争环境下，自旋重试可能会导致 CPU 资源浪费。

3. **CAS 如何避免 ABA 问题？**

   - 通过使用版本号或时间戳来扩展 CAS 操作。例如，Java 中的 `AtomicStampedReference` 类通过添加一个标记（版本号）来解决 ABA 问题。

4. **CAS 在 Java 中的实现原理是什么？**

   - Java 中的 CAS 操作通常由 `Unsafe` 类提供的本地方法实现，依赖于底层硬件的支持。`Unsafe` 类提供了 `compareAndSwapInt`、`compareAndSwapLong` 等方法，通过调用 CPU 的原子指令来实现。

5. **CAS 与锁机制的区别是什么？**
   - **锁机制**：通过锁定资源来确保线程安全，可能导致线程阻塞和上下文切换。
   - **CAS**：通过原子操作来实现线程安全，不会导致线程阻塞，但在高竞争环境下可能会导致自旋开销。
6. 自旋过长如何解决
   - 自旋次数限制：可以通过设置自旋次数的上限来避免自旋过长,分治或分段处理（将共享数据进行分段或分治处理）
   - 优化数据结构和算法、优化业务逻辑、调整线程数量、引入锁、增加缓存，核心是减少竞争和冲突

### 场景

- **原子变量类**：如 `AtomicInteger`、`AtomicBoolean` 等。
- **并发数据结构**：如 `ConcurrentHashMap`。
- **无锁算法**：如无锁队列、无锁栈等。
